      SUBROUTINE CALFP(NDIM,KDIM,NTOT,N,KTOT,K,KVVP,KFAC,
     1                 F,FI,FJ,S,VP,U,V,DI,IDJ)
      COMMON /ENSOR/LEC,IMP
      DIMENSION F(NDIM,KDIM),S(KDIM,KDIM),U(NDIM,KFAC),V(KDIM,KFAC)
      DIMENSION FI(NDIM),FJ(KDIM),DI(NDIM),VP(KDIM),IDJ(KDIM)
      DO 10 I=1,NTOT
      DI(I)=1.0
10    IF (I.GT.N) DI(I)=0.0
      CALL CORRL(NDIM,KDIM,N,KTOT,F,DI,S,FI,FJ,M)
      WRITE(IMP,100)
      MODK=2
      CALL KLICO(MODK,KDIM,KDIM,KTOT,KTOT,S,IDJ,IDJ)
      CALL VVPRO(KDIM,K,S,VP)
      IF (KVVP.GT.K) KVVP=K
      KV=0
      DO 30 L=1,KVVP
      VP(L)=ABS(VP(L))
      IF (VP(L).LT.0.000001) GOTO 30
      KV=KV+1
      DO 20 J=1,K
20    V(J,L)=S(J,L)*SQRT(VP(L))
30    CONTINUE
      KVVP=KV
      ACTK2=SQRT(FLOAT(K))
      SOM=0.0
      DO 50 I=1,NTOT
      SOM=SOM+DI(I)
      DO 50 L=1,KVVP
      U(I,L)=0.0
      DO 40 J=1,K
	IF (FJ(J) .EQ. 0.) WRITE(IMP,99) J
99	format('ERREUR MOYENNE ',I4,' NULLE.')
      U(I,L)=U(I,L)+S(J,L)*(F(I,J)-FI(J))/FJ(J)
40    CONTINUE
      U(I,L)=U(I,L)/ACTK2
50    CONTINUE
      IF (KTOT.LE.K) RETURN
      K1=K+1
      CJ=ACTK2/SOM
      DO 70 J=K1,KTOT
      DO 70 L=1,KVVP
      V(J,L)=0.0
      DO 60 I=1,N
      CC=DI(I)*CJ/SQRT(VP(L))
60    V(J,L)=V(J,L)+CC*U(I,L)*(F(I,J)-FI(J))/FJ(J)
70    CONTINUE
      RETURN
100   FORMAT(1H1/1H0,10X,'MATRICE DES CORRELATIONS (INDIVIDUS ACTIFS)')
      END
