      SUBROUTINE CALFC(NDIM,KDIM,NTOT,N,KTOT,K,KVVP,KFAC,
     1                 F,FI,FJ,S,VP,VPTOT,U,V,DI,DJ)
      COMMON /ENSOR/LEC,IMP
      DIMENSION F(NDIM,KDIM),S(KDIM,KDIM),U(NDIM,KFAC),V(KDIM,KFAC)
      DIMENSION FI(NDIM),FJ(KDIM),DI(NDIM),VP(KDIM),DJ(KDIM)
	IF (KVVP.GE.K) KVVP=K-1
	FTOT=0.0
	DO 10 J=1,KTOT
10	FJ(J)=0.0
	DO 20 I=1,NTOT
20	FI(I)=0.0
	DO 30 J=1,K
	DO 30 L=1,J
30	S(J,L)=0.0
	DO 70 I=1,N
	DO 40 J=1,K
40	FI(I)=FI(I)+F(I,J)
	FTOT=FTOT+FI(I)
	IF (FI(I).LT.1.E-06) FI(I)=1.E-06
	DO 50 J=1,K
	DO 50 L=1,J
50	S(J,L)=S(J,L)+F(I,J)*F(I,L)/FI(I)
	DO 60 J=1,KTOT
60	FJ(J)=FJ(J)+F(I,J)
70	CONTINUE
	IF (NTOT.EQ.N) GOTO 100
	N1=N+1
	DO 90 I=N1,NTOT
	DO 80 J=1,K
80	FI(I)=FI(I)+F(I,J)
90	IF (FI(I).LT.1.E-06) FI(I)=1.E-06
100	CONTINUE
	DO 110 J=1,K
	DO 110 L=1,J
	SD=FJ(J)*FJ(L)
	IF (SD.LT.1.E-12) SD=1.E-12
	S(J,L)=S(J,L)/SQRT(SD)
110	S(L,J)=S(J,L)
	VPTOT=0.0
	DO 120 L=1,K
120	VPTOT=VPTOT+S(L,L)
	VPTOT=VPTOT-1.
      CALL VVPRO(KDIM,K,S,VP)
	DO 130 J=1,KTOT
	DJ(J)=0.0
	IF (FJ(J).LT.1.E-06) FJ(J)=1.E-06
130	FJ(J)=FJ(J)/FTOT
	DO 170 I=1,NTOT
	DO 140 L=1,KVVP
	U(I,L)=0.0
	L1=L+1
	DO 140 J=1,K
140	U(I,L)=U(I,L)+(F(I,J)*S(J,L1))/(FI(I)*SQRT(FJ(J)))
	DI(I)=0.0
	DO 150 J=1,K
150	DI(I)=DI(I)+(F(I,J)/FI(I)-FJ(J))**2/FJ(J)
	FI(I)=FI(I)/FTOT
	IF (I.GT.N) GOTO 170
	DO 160 J=1,KTOT
160 	DJ(J)=DJ(J)+(F(I,J)/(FTOT*FJ(J))-FI(I))**2/FI(I)
170	CONTINUE
	DO 180 J=1,K
	DO 180 L=1,KVVP
	L1=L+1
180	V(J,L)=(S(J,L1)/SQRT(FJ(J)))*SQRT(VP(L1))
	IF (KTOT.EQ.K) RETURN
	K1=K+1
	DO 190 J=K1,KTOT
	DO 190 L=1,KVVP
190	V(J,L)=0.0
	DO 210 I=1,N
	DO 200 J=K1,KTOT
	DO 200 L=1,KVVP
	L1=L+1
200	V(J,L)=V(J,L)+(F(I,J)*U(I,L))/(FTOT*FJ(J)*SQRT(VP(L1)))
210	CONTINUE
      RETURN
      END
